# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2024 Texas Instruments Incorporated - https://www.ti.com/
#

proc debug_print { args } {
	set distanceToTop [info level]
	set call_stack ""
	for {set i 1} {$i < $distanceToTop} {incr i} {
          set callerlevel [expr {$distanceToTop - $i}]
          set caller [info level $callerlevel]
		  set call_stack $caller:$call_stack
    }
	set call_stack root:$call_stack
	puts "XXXXXX:DEBUG($call_stack): $args"
}

proc printLine {frame_info} {
    # Getting value of the key 'line' from the dictionary
    # returned by 'info frame'
    set result [dict get [info frame $frame_info]  line]
}
# Use: for printing line number:
# puts [ printLine [info frame] ]

source [find bitsbytes.tcl]

# Device info
if { [info exists CHIPNAME] } {
	set _CHIPNAME $CHIPNAME
} else {
	set _CHIPNAME cc2340rx
}

if { [info exists DAP_SWD_ID] } {
	set _DAP_SWD_ID $DAP_SWD_ID
} else {
	set _DAP_SWD_ID 0x6ba02477
}

source [find target/swj-dp.tcl]

set _DAP_ID $_DAP_SWD_ID

# Create and add DAP and target
swj_newdap $_CHIPNAME cpu -irlen 4 -expected-id $_DAP_ID
dap create $_CHIPNAME.dap -chain-position $_CHIPNAME.cpu
set _TARGETNAME $_CHIPNAME.cpu


target create $_TARGETNAME cortex_m -dap $_CHIPNAME.dap

#set _FLASHNAME $_CHIPNAME.flash

# Configure memory regions (MAIN flash and CCFG)
#flash bank $_FLASHNAME.ccfg cc2340r5 0x4e020000 0x00000800 0 0 $_TARGETNAME
#flash bank $_FLASHNAME.main cc2340r5 0x00000000 0x00080000 0 0 $_TARGETNAME

# Soft reset configuration (?)
cortex_m reset_config sysresetreq

$_TARGETNAME configure -event gdb-attach {
	debug_print "gdb-attach"

	set device_status [$::_CHIPNAME.dap apreg 1 0xc]
	debug_print "gdb-attach: DEVICESTATUS: $device_status"
    $::_TARGETNAME arp_examine
    # gdb-attach default rule
    halt 1000
}

$_TARGETNAME configure -event examine-start {
	# Print info
	debug_print "examine-start"

	# Print current device status
	set device_status [$::_CHIPNAME.dap apreg 1 0xc]
	debug_print "DEVICESTATUS: $device_status"

	cc2340r5_handle_reset
	# If at least one of bits 14 or 15 is not 1 (BOOTSTA field) it means
	# the device is not in application boot flow. Check if it is a blank device
	if { [expr { $device_status & 0xc000 }] != 0xc000 } {
		cc2340r5_handle_blank_device
	}

	# Print current device status
	set device_status [$::_CHIPNAME.dap apreg 1 0xc]
	debug_print "DEVICESTATUS: $device_status"
}

$_TARGETNAME configure -event examine-fail {
	debug_print "examine fail"
}

$_TARGETNAME configure -event examine-end {
	debug_print "examine-end"
}

# RAM
if { [info exists WORKAREABASE] } {
	set _WORKAREABASE $WORKAREABASE
} else {
	set _WORKAREABASE 0x20000000
}
if { [info exists WORKAREASIZE] } {
	set _WORKAREASIZE $WORKAREASIZE
} else {
    # SRAM size is 36K
	set _WORKAREASIZE 0x9000
}

$_TARGETNAME configure -work-area-phys $_WORKAREABASE -work-area-size $_WORKAREASIZE -work-area-backup 0

proc cc2340r5_handle_reset { } {
	# Reset the device
	debug_print "cmd reset"
	cmsis-dap cmd 0x10 0x20 0xA0 0x00 0x00 0x00 0x00
	cmsis-dap cmd 0x10 0xA0 0xA0 0x00 0x00 0x00 0x00
	debug_print "cmd reset"
	dap init
}

# Check if the current device is a blank device (i.e., both MAIN flash and CCFG are empty)
# Flash a dummy application if that is the case
proc cc2340r5_handle_blank_device { } {
	debug_print "Handle Blank device"
	# Reset the device
	debug_print "cmd reset"
	cmsis-dap cmd 0x10 0x20 0xA0 0x00 0x00 0x00 0x00
	cmsis-dap cmd 0x10 0xA0 0xA0 0x00 0x00 0x00 0x00
	debug_print "cmd reset"

	# Still don't understand how `dap init` works and why/if it is needed, but it seems necessary
	# for the execution of the following instructions after the reset with cmsis-dap commands
	dap init

	# Read DEVICESTATUS register
	debug_print "read"
	set device_status [$::_CHIPNAME.dap apreg 1 0xc]
	debug_print "DEVICESTATUS: $device_status"
	debug_print "read"

	# Execute noop to check if SACI is working correctly (SACI command value 0x1)
	set SACI_CMD_MISC_NO_OPERATION 0x1
	eval cc2340r5_execute_saci_command $SACI_CMD_MISC_NO_OPERATION

	# Check if MAIN flash is empty (SACI command value 0x10)
	# Parameter word 1 - firstSectorAddr: Address of the first byte of the first sector
	# Parameter word 2 - byteCount: Number of bytes to calculate CRC32 over
	# Parameter word 3 - expCrc32: Expected CRC32
	debug_print "Checking MAIN flash..."
	set SACI_CMD_FLASH_VERIFY_MAIN_SECTORS 0x80000010
	set rxd [cc2340r5_execute_saci_command $SACI_CMD_FLASH_VERIFY_MAIN_SECTORS 0x00000000 0x80000 0x0]
	# If first 24 bits of RXD match with first 24 bits of the command, the MAIN flash is empty
	set main_empty [ expr {[ expr { $SACI_CMD_FLASH_VERIFY_MAIN_SECTORS & 0x00ffffff }] == [ expr { $rxd & 0x00ffffff }]}]
	debug_print "MAIN flash empty: $main_empty"

	# Check if CCFG is empty (SACI command value 0x11)
	# Parameter word 1 - expBootCfgCrc32: Expected CRC32 of the boot configuration part
	# Parameter word 2 - expCentralCrc32: Expected CRC32 of the central part
	# Parameter word 3 - expUserRecCrc32: Expected CRC32 of the user record part
	# Parameter word 4 - expDebugCfgCrc32: Expected CRC32 of the debug configuration part
	debug_print "Checking CCFG..."
	set SACI_CMD_FLASH_VERIFY_CCFG_SECTOR 0x80000011
	set rxd [cc2340r5_execute_saci_command $SACI_CMD_FLASH_VERIFY_CCFG_SECTOR 0x0 0x0 0x0 0x0]
	# If first 24 bits of RXD match with first 24 bits of the command, the CCFG is empty
	set ccfg_empty [ expr {[ expr { $SACI_CMD_FLASH_VERIFY_CCFG_SECTOR & 0x00ffffff }] == [ expr { $rxd & 0x00ffffff }]}]
	debug_print "CCFG empty: $ccfg_empty"

	# If both MAIN flash and CCFG are empty, flash dummy application (SACI command value 0x0c)
	if {[ expr { $main_empty == 1 }] && [ expr { $ccfg_empty == 1 }]} {
		debug_print "Writing dummy application..."

		# Flash MAIN (SACI command 0x0e)
		# Parameter word 1  - key: Flash operation key (magic number) (0xB7E3A08F)
		# Parameter word 2  - firstByteAddr: Address of the first byte to be programmed
		# Parameter word 3+ - data: Bytes to be programmed
		debug_print "Flashing MAIN..."
		set SACI_CMD_FLASH_PROG_MAIN_SECTOR 0x000c000e
		eval cc2340r5_execute_saci_command $SACI_CMD_FLASH_PROG_MAIN_SECTOR 0xB7E3A08F 0x00000000 0x20001000 0x00000009 0xE7FEB500

		# Flash CCFG (SACI command 0x0c)
		# Parameter word 1     - key: Flash operation key (magic number) (0xB7E3A08F)
		# Parameter word 513:2 - data: Bytes to be programmed
		debug_print "Flashing CCFG..."
		set SACI_CMD_FLASH_PROG_CCFG_SECTOR 0x0c
		eval cc2340r5_execute_saci_command $SACI_CMD_FLASH_PROG_CCFG_SECTOR 0xB7E3A08F 0xFFFFFFFF 0x00000000 0x00000000 0xFFFFFFFF 0xFFFFFFFF 0xFFFFFFFF 0xAAAAAAAA 0x0000000F 0xFFFFFFFF 0xFFFFFFFF 0x00000000 0xFFFFFFFF 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x4C1584B6 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x00000000 0x15D70E0C 0x0000A55A 0x03020101 0x150D0805 0x36E4D76D 0xDF31F4EB 0xEE15AE95 0xE48EBA03 0xD83FC6C4 0x5E673F45 0x01C2D774 0xE558902C 0x527294A2

		# Check if CCFG is empty (SACI command value 0x11)
		# Parameter word 1 - expBootCfgCrc32: Expected CRC32 of the boot configuration part
		# Parameter word 2 - expCentralCrc32: Expected CRC32 of the central part
		# Parameter word 3 - expUserRecCrc32: Expected CRC32 of the user record part
		# Parameter word 4 - expDebugCfgCrc32: Expected CRC32 of the debug configuration part
		debug_print "Checking CCFG (CRC check)..."
		set SACI_CMD_FLASH_VERIFY_CCFG_SECTOR 0x00000011
		cc2340r5_execute_saci_command $SACI_CMD_FLASH_VERIFY_CCFG_SECTOR 0x0 0x0 0x0 0x0

		# SWD to DORMANT
		cmsis-dap cmd 0x12 0x48 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xBC 0xE3

		# Reset the device
		debug_print "cmd reset"
		cmsis-dap cmd 0x10 0x20 0xA0 0x00 0x00 0x00 0x00
		cmsis-dap cmd 0x10 0xA0 0xA0 0x00 0x00 0x00 0x00
		debug_print "cmd reset"

		# Repeat the same sequence OpenOCD does at the beginning of the connection
		cmsis-dap cmd 0x00 0xF0
		cmsis-dap cmd 0x00 0x04
		cmsis-dap cmd 0x00 0x03
		cmsis-dap cmd 0x02 0x01
		cmsis-dap cmd 0x00 0xFF
		cmsis-dap cmd 0x00 0xFE
		cmsis-dap cmd 0x10 0x00 0x00 0x00 0x00 0x00 0x00
		cmsis-dap cmd 0x11 0x80 0x96 0x98 0x00
		cmsis-dap cmd 0x04 0x00 0x40 0x00 0x00 0x00
		cmsis-dap cmd 0x13 0x00
		cmsis-dap cmd 0x01 0x00 0x01
		cmsis-dap cmd 0x01 0x01 0x01
		cmsis-dap cmd 0x11 0x80 0x96 0x98 0x00
		cmsis-dap cmd 0x03
		cmsis-dap cmd 0x02 0x01
		cmsis-dap cmd 0x12 0x88 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0x9E 0xE7 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0x00
		cmsis-dap cmd 0x11 0x80 0x96 0x98 0x00
		cmsis-dap cmd 0x05 0x00 0x01 0x02
		cmsis-dap cmd 0x03
		cmsis-dap cmd 0x02 0x01
		cmsis-dap cmd 0x12 0x28 0xFF 0x75 0x77 0x77 0x67
		cmsis-dap cmd 0x11 0x80 0x96 0x98 0x00
		cmsis-dap cmd 0x03
		cmsis-dap cmd 0x02 0x01
		cmsis-dap cmd 0x12 0xE0 0xFF 0x92 0xF3 0x09 0x62 0x95 0x2D 0x85 0x86 0xE9 0xAF 0xDD 0xE3 0xA2 0x0E 0xBC 0x19 0xA0 0xF1 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0x00
		cmsis-dap cmd 0x11 0x80 0x96 0x98 0x00
		cmsis-dap cmd 0x05 0x00 0x01 0x02
		cmsis-dap cmd 0x05 0x00 0x01 0x00 0x1E 0x00 0x00 0x00
		cmsis-dap cmd 0x05 0x00 0x05 0x08 0x00 0x00 0x00 0x00 0x04 0x20 0x00 0x00 0x50 0x06 0x04 0x00 0x00 0x00 0x50 0x06
		cmsis-dap cmd 0x05 0x00 0x01 0x06
		cmsis-dap cmd 0x05 0x00 0x03 0x06 0x04 0x00 0x00 0x00 0x50 0x06
		cmsis-dap cmd 0x05 0x00 0x03 0x08 0x00 0x00 0x00 0x01 0x0F 0x0E
	}
}

set _reg_txd 0x0
set _reg_txctl 0x4
set _reg_rxd 0x8
set _reg_rxctl 0xc

proc cc2340r5_wait_txctl_empty {} {
	global _reg_txctl

	debug_print Wait for txctl empty
	# Wait until TXCTL::TXD_FULL/TXSTA = 0
	set timeout 1000
	while { [expr { [$::_CHIPNAME.dap apreg 2 $_reg_txctl] & 0x1}] != 0x0 } {
		sleep 1
		debug_print iteration: $timeout
		set timeout [expr {$timeout - 1}]
		if { $timeout == 0 } {
			set txctl [$::_CHIPNAME.dap apreg 2 $_reg_txctl]
			return -code error [format "TXCTL=0x%08x timeout" $txctl]
		}
	}
}

proc cc2340r5_saci_send {command args} {
	global _reg_txd
	global _reg_txctl
	global _reg_rxctl

	debug_print $command $args
	# Max sure that the txctl is empty status
	eval cc2340r5_wait_txctl_empty

	# Set bit 1 of TXCTL (0x204): CMD_START
	# Indicates that TXD contains the first word of a command
	$::_CHIPNAME.dap apreg 2 $_reg_txctl 0x2
	# Set the command data
	$::_CHIPNAME.dap apreg 2 $_reg_txd $command

	foreach arg $args {
		debug_print first argument $arg
		eval cc2340r5_wait_txctl_empty
		# Clear bit 1 of TXCTL (0x204): To indicate follow on data
		$::_CHIPNAME.dap apreg 2 $_reg_txctl 0x0
		# Follow on argument
		$::_CHIPNAME.dap apreg 2 $_reg_txd $arg
	}
	eval cc2340r5_wait_txctl_empty
}

proc cc2340r5_wait_rxctl_full {} {
	global _reg_rxctl

	debug_print Wait for rxctl full
	# Wait until RXCTL::RXD_FULL/RXDSTA = 1
	set timeout 1000
	while { [expr { [$::_CHIPNAME.dap apreg 2 $_reg_rxctl] & 0x1}] != 0x1 } {
		sleep 1
		debug_print iteration: $timeout
		set timeout [expr {$timeout - 1}]
		if { $timeout == 0 } {
			set rxctl [$::_CHIPNAME.dap apreg 2 $_reg_rxctl]
			set error_stat ""
			if	{ [expr { $rxctl & 0x2}] != 0x0} {
				set error_stat "$error_stat CMD_ABORTED"
			}
			if	{ [expr { $rxctl & 0x4}] != 0x0} {
				set error_stat "$error_stat CMD_WORKING"
			}
			if	{ [expr { $rxctl & 0x8}] != 0x0} {
				set error_stat "$error_stat CMD_ERROR"
			}
			return -code error [format "RXCTL=0x%08x timeout: $error_stat" $rxctl]
		}
	}
}

proc cc2340r5_saci_get {num_args} {
	global _reg_rxd

	debug_print $num_args values

	set resp {}
	while { $num_args > 0 } {
		eval cc2340r5_wait_rxctl_full
		set rxd [$::_CHIPNAME.dap apreg 2 $_reg_rxd]
		lappend resp $rxd
		set num_args [expr {$num_args - 1}]
	}

	return $resp
}

# Get device Status
proc cc2340r5_get_device_status {} {
	set device_status [$::_CHIPNAME.dap apreg 1 0xc]
	return $device_status
}

# Check SACI connection
proc cc2340r5_saci_cmd_misc_no_operation {} {
	eval cc2340r5_saci_send 0x01
	set resp [cc2340r5_saci_get 1]
	return $resp
}

# Print DIE ID
proc cc2340r5_saci_cmd_misc_get_die_id {} {
	eval cc2340r5_saci_send 0x03
	set resp [cc2340r5_saci_get 5]
	return $resp
}

# Shutdown the device
proc cc2340r5_saci_cmd_debug_exit_saci_shutdown {} {
	eval cc2340r5_saci_send 0x08
	# may not get a response
	set resp [cc2340r5_saci_get 1]
	return $resp
}

# Execute a SACI command.
# Parameters:
# 	command: The value representing the SACI command to execute
# 	args: List of parameter words
# Returns:
# 	The value contained in the RXD register after the execution of the requested SACI command
proc cc2340r5_execute_saci_command {command args} {
	# Read TXCTL (0x204) (for debug purposes)
	set txctl [$::_CHIPNAME.dap apreg 2 0x4]
	debug_print "txctl: $txctl"

	# Read RXCTL (0x20c) (for debug purposes)
	set rxctl [$::_CHIPNAME.dap apreg 2 0xc]
	debug_print "rxctl: $rxctl"

	# Set bit 1 of TXCTL (0x204): CMD_START
	# Indicates that TXD contains the first word of a command
	$::_CHIPNAME.dap apreg 2 0x4 0x2

	# Set TXD (0x200)
	$::_CHIPNAME.dap apreg 2 0x0 $command

	# Read TXCTL (0x204) (for debug purposes)
	set txctl [$::_CHIPNAME.dap apreg 2 0x4]
	debug_print "txctl: $txctl"

	# Clear TXCTL (0x204)
	$::_CHIPNAME.dap apreg 2 0x4 0x0

	# Write additional parameter words
	foreach {param_word} $args {
		# debug_print "param_word: $param_word"
		$::_CHIPNAME.dap apreg 2 0x0 $param_word
	}

	# Wait for the command to finish the execution
	# Probably this delay could be optimized
	sleep 1000

	# Read RXCTL (0x20c) (for debug purposes)
	set rxctl [$::_CHIPNAME.dap apreg 2 0xc]
	debug_print "rxctl: $rxctl"

	# Read RXD (0x208) (to retrieve the response, if relevant)
	set rxd [$::_CHIPNAME.dap apreg 2 0x8]
	debug_print "rxd  : $rxd"

	return $rxd
}
